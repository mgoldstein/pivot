<?php


function pivot_campaign_menu() {

  $items['admin/config/campaign'] = array(
    'page callback' => 'drupal_get_form',
    'page arguments' => array('pivot_campaign_config'),
    'access arguments' => array('administer nodes'),
  );

  return $items;
}


 function pivot_campaign_config(){
  $form['pivot_campaign_path'] = array(
    '#type' => 'form',
    '#title' => t('Campaign Config'),
    '#description' => t("Path with no leading or trailing slash.  Example 'campaign/dml"),
  );

  $form = system_settings_form($form);
  return $form;
}


 function pivot_campaign_block_info(){
  $blocks = array();
  $blocks['pivot_campaign_hero'] = array(
    'info' => t('Campaign Hero')
   );
  return $blocks;
 }


function pivot_campaign_block_view($delta = ''){
  //The $delta parameter tells us which block is being requested.
  $block = array();
  switch ($delta) {
    case 'pivot_campaign_hero':
      $block['content'] = pivot_campaign_hero();
      break;
  }
  return $block;
  }

// function pivot_campaign_hero() {
//   $node = node_load(arg(1));
//   $hero_image = '<img src="'.file_create_url($node->field_header_image['und'][0]['uri']). '" alt="'. $node->field_promo_headline['und'][0]['value']. '">';
//   $headline_link = l($node->title, 'node/'. $node->nid);

//   return theme('pivot_campaign_hero', array('node' => $node, 'hero_image' => $hero_image, 'headline_link' => $headline_link, 'hero_menu' => $hero_menu));
// }
function pivot_campaign_hero() {
  if(arg(0) == 'node'){
    $node1 = node_load(arg(1));
    $path = drupal_get_path_alias(current_path());
    $pos = (strpos($path, '/', strpos($path, '/') + 1) == NULL ? strlen(current_path()) : strpos($path, '/', strpos($path, '/') + 1));
    $alias = substr($path, 0 , $pos);
    $subalias = substr($alias, 0, 9);
    if($node1->type == 'campaign'){
      $node = $node1;
    }
    elseif($subalias == 'campaigns'){
      $path = drupal_lookup_path('source', $alias);
      $node = menu_get_object("node", 1, $path);
    }
  }
  elseif(arg(0) == 'campaigns') {
    $current_path = current_path();
    $pos = strpos($current_path, '/', strpos($current_path, '/') + 1 );
    $alias = substr(current_path(), 0 , $pos);
    $path = drupal_lookup_path('source', $alias);
    $node = menu_get_object("node", 1, $path);
  }

  $hero_image = '<img src="'.file_create_url($node->field_header_image['und'][0]['uri']). '" alt="'. (isset($node->field_promo_headline['und'][0]['value']) ? $node->field_promo_headline['und'][0]['value'] : ''). '">';
  $headline_link = l($node->title, 'node/'. $node->nid);
  $nice_menus = theme('nice_menus', array(
    'id' => 100,
    'menu_name' => $node->field_header_menu['und'][0]['value'],
    'mlid' => 0,
    'direction' => 'down',
    'depth' => '-1',
    'respect_expanded' => FALSE
  ));
  return theme('pivot_shows_hero', array('node' => $node, 'hero_image' => $hero_image, 'headline_link' => $headline_link, 'hero_menu' => $nice_menus['content']));
}

function pivot_campaign_theme() {
  return array(
    'pivot_campaign_hero' => array(
      'variables' => array(
        'node' => '',
        'hero_image' => '',
        'hero_menu' => '',
        'headline_link' => '',
      ),
      'arguments' => array(),
      'template' => 'pivot-campaign-hero'
    ),
  );
}

function pivot_campaign_menu_title(&$title) {
  $title = strtolower($title);
  $title = preg_replace("/[^a-z0-9_\s-]/", "", $title);
  $title = preg_replace("/[\s-]+/", " ", $title);
  $title = preg_replace("/[\s_]/", "-", $title);
}
function pivot_campaign_node_presave($node) {
  if($node->type == 'campaign' && !isset($node->field_header_menu['und'][0]['value'])){
    $title = $node->title;
    pivot_campaign_menu_title($title);
    $menu = array(
     'menu_name' => 'campaign-'. $title,
     'title' => $node->title,
     'description' => 'Campaign Menu For '. $node->title,
    );
    menu_save($menu); //uncomment this line when ready and no longer testing
    $node->field_header_menu['und'][0]['value'] = 'campaign-'. $title;
  }
}

function pivot_campaign_form_alter(&$form, &$form_state, $form_id) {
  if($form_id == 'campaign_node_form') {
    $form['field_header_menu']['#type'] = 'hidden';
  }
}

function pivot_campaign_node_submit($node, $form, &$form_state) {
  $title = $node->title;
  pivot_campaign_menu_title($title);
  $form_state['redirect'] = 'admin/structure/menu/manage/campaign-'. $title; //THIS DOESN'T WORK.
}






<?php
/* Do something crazy */

/**
 * Implements hook_block_info()
 */
function pivot_navigation_block_info(){
	return array(
		'pivot_navigation' => array(
			'info' => t('Pivot Navigation')
		),
		'pivot_navigation_collab' => array(
		 'info' => t('Pivot Collab')
		)
	);
}

/**
 * Implements hook_block_view()
 */
function pivot_navigation_block_view($delta = ''){
	switch($delta){
		case 'pivot_navigation':
			$block['subject'] = NULL;
			$block['content'] = _pivot_navigation_slim_block_gen();
			return $block;
			break;
		case 'pivot_navigation_collab':
			$block['subject'] = NULL;
			$block['content'] = _pivot_navigation_slim_collab_gen();
      return $block;
			break;
	}
}

/* Callback for 'pivot_navigation' block */
//function pivot_navigation_global_menu(){
//	/*
//	 * TODO:
//	 * 3) get the collab image (what is this)
//	 * 4) print user registration div (need the tpsLogin js for pivot)
//	 * 5) send that through the theme processor
//	 * 6) http://stream1.gifsoup.com/view8/20131226/4935715/chappelle-mic-drop-o.gif
//	 */
//
//	/* Get the main menu */
//	$menu_depth = 2;
//	$menu_tree = menu_tree_all_data('menu-primary', null, $menu_depth);
//	$menu = drupal_render(menu_tree_output($menu_tree));
//
//	/* Get the social menu */
//	$social_menu_depth = 2;
//	$social_menu_tree = menu_tree_all_data('menu-follow-us', null, $social_menu_depth);
//	$social_menu = drupal_render(menu_tree_output($social_menu_tree));
//
//	$collab = 'collab';
//	$items = array(
//		'menu' => $menu,
//		'social_menu' => $social_menu,
//		'collab' => $collab
//	);
//	$block = theme('pivot_navigation', $items);
//	return $block;
//}

/**
 * Implements hook_theme()
 */
function pivot_navigation_theme(){
	return array(
		'pivot_navigation' => array (
			'template' => 'templates/navigation',
			'variables' => array (
				'logo' => NULL,
				'slimnav' => NULL,
				'social_menu' => NULL,
				'search' => NULL,
				'right_info' => NULL,
				'left_info' => NULL
			)
		)
	);
}


/**
 *  @function:
 *    This function is used to generate the custom collab block
 *
 *    @param:
 *      normal_state = markup for the normal state
 *      focus_state = markup for the focus/hover state
 */
function _pivot_navigation_slim_collab_gen($normal_state = NULL, $focus_state = NULL, $classes = array()) {
	$output = '';
	//allows other modules to hook in and alter the output
	drupal_alter('pivot_collab', $normal_state, $focus_state, $classes);
	//only return something if title is set
	if (!empty($normal_state)) {
		//appends the custom js to handle the block on desktop and mobile
		drupal_add_js(drupal_get_path('module', 'pivot_navigation') . '/js/navigation.js', 'file');

		//normal state
		$normal_state_wrapper = theme('html_tag', array(
			'element' => array(
				'#tag' => 'div',
				'#value' => $normal_state,
				'#attributes' => array(
					'class' => 'normal-state',
				))));

		//focus state
		$focus_state_wrapper = theme('html_tag', array(
			'element' => array(
				'#tag' => 'div',
				'#value' => $focus_state,
				'#attributes' => array(
					'class' => 'focus-state',
					'style' => 'display: none;'
				))));

		//main wrapper for both states
		$output = theme('html_tag', array(
			'element' => array(
				'#tag' => 'div',
				'#value' => $normal_state_wrapper . $focus_state_wrapper,
				'#attributes' => array(
					'class' => 'pivot-collab-block ' . implode(' ', $classes),
				))));
	}
	return $output;
}

/**
 *  Implements hook_tp_process_slim_nav_alter().
 */
function pivot_navigation_pivot_preprocess_slim_nav_alter(&$data) {
	//custom block for the collab
	$block = block_load('pivot_navigation', 'pivot_navigation_collab');
	$block_content = drupal_render(_block_get_renderable_array(_block_render_blocks(array($block))));

	//adds tap login
	$tap_login = '<div class="tpsLogin"></div>';

	//add it to the right_info
	$data['right_info'] = $block_content . $tap_login;
}

/**
 *  @function:
 *    This function is used to parse the mobile menu as it was not pulling in the secondary levels
 */
function _pivot_navigation_menu_parser($mobile_menu) {
	//TODO: make sure we have all of the contrib modules and modifications necessary
	$mobile_menu_processed = array();
	//does for each item
	foreach ($mobile_menu as $menu => $value) {
		//creates the menu
		$mobile_menu_processed[$value['link']['mlid']] = array(
			'#title' => $value['link']['link_title'],
			'#href' => $value['link']['link_path'],
			'#theme' => 'menu_link__' . str_replace('-', '_', (strtolower($value['link']['menu_name']))),
			'#attributes' => array(
				'class' => $value['link']['options']['#attributes'],
			),
			'#original_link' => $value['link'],
			'#below' => (!empty($value['below'])) ? _pivot_navigation_menu_parser($value['below']) : '',
			'#localized_options' => $value['link']['localized_options']
		);

		//ensures we add an extra class to be normal
		$mobile_menu_processed[$value['link']['mlid']]['#attributes']['class'][] = 'normal';
	}

	return $mobile_menu_processed;
}

/**
 *  @function:
 *    THis function is a modified clone of the megamenu and slim nav
 *
 *    @param:
 *      $menu = the menu to pull in and process
 */
function _pivot_navigation_menu_handler($menu = NULL) {
	$output = '';
	$items = array();

	//return empty if menu is not set
	if (empty($menu)) {
		return '';
	}

	//grabs the mega tree
	$mega_tree = menu_tree_all_data($menu, $link = NULL, $max_depth = 2);

	//does each tree
	foreach ($mega_tree as $key => $link) {
		//default variables
		$attributes = $link_data = $see_more = $categories = $left_menu = '';

		//gets the path
		$path = drupal_get_path_alias($mega_tree[$key]['link']['link_path']);
		$attributes = $link['link']['options']['attributes'];
		$attributes['class'] = array($link['link']['options']['attributes']['class'][0]);
		$title = '<div class="title first-level">'. l($mega_tree[$key]['link']['link_title'], $path, array('attributes' => $attributes)). '</div>';

		//limits down the menu to 10 items. @dev: this is disabled for now
		//$bottom_menu = array_slice($mega_tree[$key]['below'], 0, 10);
		$bottom_menu = $mega_tree[$key]['below'];

		//left menu curation
		$menu = render(menu_tree_output($bottom_menu));
		$menu_text = ($link['link']['options']['attributes']['title'] ? $link['link']['options']['attributes']['title'] : '');
		$left_menu = theme('tp_megamenu_inner_left', array('left_menu' => $menu, 'left_menu_text' => $menu_text));

		//only add if there is a second level
		if (!empty($link['below'])) {
			//return more link
			if (isset($link['link']['options']['attributes']['name'])) {
				$see_more = l(
					$link['link']['options']['attributes']['name'],
					$path,
					array(
						'attributes' => array(
							'class' => array('right-more')
						)
					)
				);
			}
			else {
				$see_more = l(
					'See More '. $link['link']['link_title'],
					$path,
					array(
						'attributes' => array(
							'class' => array('right-more')
						)
					)
				);
			}
		}

		$mega_content_wrapper = theme('html_tag', array(
			'element' => array(
				'#tag' => 'div',
				'#value' => $left_menu . $see_more,
				'#attributes' => array(
					'class' => 'mega-content-wrapper',
				))));

		$link_mega_wrapper = theme('html_tag', array(
			'element' => array(
				'#tag' => 'div',
				'#value' => $mega_content_wrapper,
				'#attributes' => array(
					'class' => 'mega-content second-level',
				))));

		//adds into array for items
		$items[] = array(
			'data' => $title . (!empty($bottom_menu) ? $link_mega_wrapper : ''),
			'class' => array("mega-item ". $link['link']['mlid'])
		);
	}

	//outputs the menu using item_list
	$output = theme('item_list', array(
		'items' => $items,
		'title' => NULL,
		'type' => 'ul'
	));

	return $output;
}

/**
 *  @function:
 *    This function is used to generate the slim nav.
 *    This function will only run when the node field brand category is set.
 */
function _pivot_navigation_slim_block_gen() {
	//default variables
	drupal_add_js('https://api.takepart.com/assets/login_widget.js', 'external');
	/* Make this static */
	$logo = '<div class="logo"></div>';
  global $base_url;
  $logo = l('', $base_url, array('attributes' => array('class' => array('logo'))));

	/* Get the social menu */
	$social_menu_depth = 2;
	$social_menu_tree = menu_tree_all_data('menu-follow-us', null, $social_menu_depth);
	$slim_nav_social_menu = drupal_render(menu_tree_output($social_menu_tree));

	//prepped array before alter
	$pre_slim_array = array(
		'logo' => $logo,
		'slimnav' => _pivot_navigation_menu_handler($menu = 'menu-primary'),
		'social_menu' => $slim_nav_social_menu,
		'right_info' => array(),
		'left_info' => array(),
	);

	//allow other modules to preprocess the slim nav array
	drupal_alter('pivot_preprocess_slim_nav', $pre_slim_array);

	//calls theme function to theme the output
	$slim_nav_output = theme('pivot_navigation', $pre_slim_array);

	//wraps the output for easier theming
	$output = theme('html_tag', array(
		'element' => array(
			'#tag' => 'div',
			'#value' => $slim_nav_output,
			'#attributes' => array(
				'class' => 'tp-slim-nav'
			)
		)
	));


	return $output;
}

/**
 *  Implements hook_tp_collab_alter().
 */
function pivot_navigation_pivot_collab_alter(&$normal_state, &$focus_state, &$classes) {
	$normal_state = '<span class="small">in collaboration with</span><br/><img src="/sites/all/themes/pivot/images/takepart_logo_white.png" style="vertical-align: middle;"/><span class="small">&nbsp;&nbsp;[?]</span>';
	$focus_state = '<a class="focus-state-link" href="http://www.takepart.com/">TakePart is the social<br/>action platform for<br/>Pivot TV. <span style="color: #018b73;">About Takepart</span></a>';
	$classes = array('takepart');
}